name: 编译 OpenWrt IPK 包

# 触发条件：push 到 main 分支，或手动在 GitHub 界面触发
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

# 任务定义
jobs:
  compile:
    runs-on: ubuntu-latest  # 使用 Ubuntu 最新版环境
    steps:
      # 步骤 1：拉取代码（包含你的 Fork 仓库代码）
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          submodules: true  # 若项目有子模块，需开启

      # 步骤 2：安装 OpenWrt 编译依赖（关键！）
      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
                              gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
                              file wget

      # 步骤 3：修改 Makefile（针对斐讯 K3 适配，可选，根据你的需求调整）
      # 若需要强制 bcm53xx 架构使用 arm_v7，添加以下命令（参考之前的问题）
      - name: 适配斐讯 K3 架构（修改 Makefile）
        run: |
          sed -i 's/NPC_ARCH:=arm_v6/NPC_ARCH:=arm_v7/' npc/Makefile  # 将 bcm53xx 对应的 arm_v6 改为 arm_v7

      # 步骤 4：编译 IPK 包（核心步骤）
      - name: 编译 npc IPK
        run: |
          # 若项目有单独的编译脚本，直接执行脚本；否则执行 make 命令
          # 示例 1：执行项目自带的编译脚本（若有）
          # bash build.sh
          # 示例 2：直接执行 make 命令（根据项目 Makefile 调整）
          make package/npc/compile V=s  # V=s 显示详细日志，便于排错

      # 步骤 5：上传编译产物（IPK 文件）到 GitHub Artifacts
      - name: 上传 IPK 产物
        uses: actions/upload-artifact@v4
        with:
          name: npc-ipk-packages
          path: |
            bin/packages/*/npc/*.ipk  # IPK 文件路径（根据项目输出目录调整）
            # 若输出在其他目录，需对应修改，例如：bin/ipk/*/*.ipk
